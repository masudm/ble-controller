<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Motor Control</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        text-align: center;
        background-color: #222;
        color: white;
        user-select: none;
      }

      /* Layout */
      .container {
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Throttle Button Styling */
      #throttleBtn {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff4b1f, #ff9068);
        border: 8px solid #444;
        box-shadow: 0 0 20px rgba(255, 75, 31, 0.6);
        cursor: pointer;
        margin: 30px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        transition: transform 0.1s, box-shadow 0.1s;
      }
      #throttleBtn:active {
        transform: scale(0.95);
        background: radial-gradient(circle, #d13a15, #d13a15);
        box-shadow: 0 0 10px rgba(255, 75, 31, 0.4);
      }

      /* Sliders */
      .slider-group {
        margin: 20px 0;
        text-align: left;
        background: #333;
        padding: 15px;
        border-radius: 10px;
      }
      input[type="range"] {
        width: 100%;
      }

      /* Direction Button */
      .dir-btn {
        background-color: #007bff;
        color: white;
        padding: 15px 40px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .dir-rev {
        background-color: #dc3545;
      }

      .status {
        color: #aaa;
        margin-top: 10px;
        font-size: 12px;
      }
      #controls {
        opacity: 0.3;
        pointer-events: none;
        transition: opacity 0.5s;
      }
      #controls.active {
        opacity: 1;
        pointer-events: all;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Motor Dashboard</h1>
      <button id="connectBtn" style="padding: 10px 20px; margin-bottom: 20px">
        Connect Bluetooth
      </button>
      <div id="statusMsg" class="status">Disconnected</div>

      <div id="controls">
        <div id="throttleBtn">GO</div>

        <button id="dirBtn" class="dir-btn">Direction: FWD</button>

        <div class="slider-group">
          <label>Top Speed: <span id="speedVal">255</span></label>
          <input type="range" id="speedSlider" min="50" max="255" value="255" />
        </div>

        <div class="slider-group">
          <label>Acceleration: <span id="accelVal">5</span></label>
          <input type="range" id="accelSlider" min="1" max="20" value="5" />
        </div>
      </div>
    </div>

    <script>
      // UUIDs matching ESP32
      const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
      const UUIDS = {
        CMD: "beb5483e-36e1-4688-b7f5-ea07361b26a8", // Run/Stop
        DIR: "88c93215-21ec-4c07-b677-268e658c9f01", // Direction
        SPEED: "c8c2e912-36c5-4309-8b43-9b884d521856", // Max Speed
        ACCEL: "d483b839-e587-4322-a7f4-301149722b40", // Acceleration
      };

      let device, server;
      let chars = {}; // Store characteristic objects here
      let isFwd = true;

      // --- Bluetooth Connection ---
      connectBtn.addEventListener("click", async () => {
        try {
          statusMsg.textContent = "Scanning...";

          // Change: Filter by Service UUID instead of Name
          device = await navigator.bluetooth.requestDevice({
            filters: [
              {
                services: [SERVICE_UUID],
              },
            ],
          });

          statusMsg.textContent = "Connecting...";
          const server = await device.gatt.connect();

          // ... rest of your existing code ...
          const service = await server.getPrimaryService(SERVICE_UUID);
          chars.cmd = await service.getCharacteristic(UUIDS.CMD);
          chars.dir = await service.getCharacteristic(UUIDS.DIR);
          chars.speed = await service.getCharacteristic(UUIDS.SPEED);
          chars.accel = await service.getCharacteristic(UUIDS.ACCEL);

          document.getElementById("statusMsg").textContent = "Connected";
          document.getElementById("connectBtn").style.display = "none";
          document.getElementById("controls").classList.add("active");
        } catch (error) {
          console.error(error);
          statusMsg.textContent = "Error: " + error;
        }
      });

      // --- Throttle Logic (Press to Run, Release to Stop) ---
      const throttleBtn = document.getElementById("throttleBtn");

      const startMotor = () => writeChar(chars.cmd, 1);
      const stopMotor = () => writeChar(chars.cmd, 0);

      // Mouse events
      throttleBtn.addEventListener("mousedown", startMotor);
      throttleBtn.addEventListener("mouseup", stopMotor);
      throttleBtn.addEventListener("mouseleave", stopMotor);

      // Touch events (for mobile)
      throttleBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        startMotor();
      });
      throttleBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        stopMotor();
      });

      // --- Direction Logic ---
      document.getElementById("dirBtn").addEventListener("click", () => {
        isFwd = !isFwd;
        const btn = document.getElementById("dirBtn");
        btn.textContent = isFwd ? "Direction: FWD" : "Direction: REV";
        btn.classList.toggle("dir-rev", !isFwd);
        writeChar(chars.dir, isFwd ? 1 : 0);
      });

      // --- Sliders Logic ---
      document.getElementById("speedSlider").addEventListener("input", (e) => {
        const val = parseInt(e.target.value);
        document.getElementById("speedVal").textContent = val;
        writeChar(chars.speed, val);
      });

      document.getElementById("accelSlider").addEventListener("input", (e) => {
        const val = parseInt(e.target.value);
        document.getElementById("accelVal").textContent = val;
        writeChar(chars.accel, val);
      });

      // Helper to write Uint8
      async function writeChar(characteristic, value) {
        if (!characteristic) return;
        try {
          const data = new Uint8Array([value]);
          await characteristic.writeValue(data);
        } catch (err) {
          console.log("Write Error: ", err);
        }
      }
    </script>
  </body>
</html>
